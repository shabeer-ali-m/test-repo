name: Deploy on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start deployment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Starting deployment for PR #' + context.issue.number
            });
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        id: deploy
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            cd /home/ubuntu/
            ./deploy.sh
      
      - name: Comment deployment result
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.deploy.outcome == 'success' && '‚úÖ' || '‚ùå' }} Deployment ${{ steps.deploy.outcome }}
            
            **Details:**
            - Branch: ${{ github.head_ref }}
            - Commit: ${{ github.sha }}
            - Status: ${{ steps.deploy.outcome == 'success' && 'Success' || 'Failed' }}
            
            ${{ steps.deploy.outcome == 'failure' && '‚ö†Ô∏è Please check the server logs for more information.' || '' }}
